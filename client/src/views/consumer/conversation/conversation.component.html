<div ng-controller="ChatControllerConsumer" ng-init="init()" class="container-fluid" style="padding: 0; background-color: #f8f9fa; min-height: 100vh;">
    <div class="row" style="margin: 0;">
        <!-- Left Panel - Conversation List -->
        <div class="col-md-3 chat-sidebar" style="padding: 0; height: 100vh; border-right: 1px solid #dee2e6; background-color: white; box-shadow: 2px 0 10px rgba(0,0,0,0.05);">
            <div class="panel panel-info" style="border-radius: 0; margin-bottom: 0; border: none; height: 100%;">
                <div class="panel-heading" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-bottom: 1px solid #dee2e6; border-radius: 0; padding: 15px;">
                    <div class="row">
                        <div class="col-xs-6">
                            <h3 style="margin: 0; font-size: 18px; color: #495057; font-weight: 500;">
                                <i class="fa fa-comments" style="color: #007bff; margin-right: 10px;"></i> Conversations
                            </h3>
                        </div>
                        <div class="col-xs-6 text-right">
                            <button go-Back id="backButton" class="btn btn-outline-secondary" style="background: transparent; border: 1px solid #ced4da; border-radius: 4px; padding: 4px 10px; transition: all 0.3s ease;">
                                <i class="fa fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="panel-body" style="padding: 0; overflow-y: auto; height: calc(100% - 56px);">
                    <div class="list-group" style="margin-bottom: 0; border-radius: 0;">
                        <a href="javascript:void(0)" ng-repeat="convo in conversations" 
                           ng-click="loadChatMessages(convo)" 
                           class="list-group-item" 
                           style="border-left: none; border-right: none; padding: 15px; transition: all 0.3s ease; cursor: pointer; border-radius: 0;">
                            <div class="media">
                                <div class="media-left" style="padding-right: 15px;">
                                    <div style="width: 40px; height: 40px; background-color: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">
                                        {{ convo.ownerName.charAt(0).toUpperCase() }}
                                    </div>
                                </div>
                                <div class="media-body">
                                    <h4 class="media-heading" style="margin-top: 2px; font-size: 16px; font-weight: 500; color: #495057;">{{ convo.ownerName }}</h4>
                                    <small style="color: #6c757d;">Tap to view conversation</small>
                                </div>
                            </div>
                        </a>
                        <div class="list-group-item text-center" ng-if="conversations.length === 0" style="padding: 20px; color: #6c757d;">
                            <i class="fa fa-inbox fa-2x" style="margin-bottom: 10px; color: #adb5bd;"></i>
                            <p style="margin: 0;">No conversations yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Chat Window -->
        <div class="col-md-9 chat-main" style="padding: 0; height: 100vh;">
            <div class="panel panel-default" style="border-radius: 0; margin-bottom: 0; border: none; height: 100%;">
                <!-- Chat Header -->
                <div class="panel-heading" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-bottom: 1px solid #dee2e6; border-radius: 0; padding: 15px;">
                    <h3 style="margin: 0; font-size: 18px; color: #495057; font-weight: 500;">
                        <i class="fa fa-user" style="color: #28a745; margin-right: 10px;"></i> 
                        {{ chatTitle || 'Select a conversation to start chatting' }}
                    </h3>
                </div>
                
                <div class="panel-body" style="padding: 0; height: calc(100% - 56px); display: flex; flex-direction: column;">
                    <!-- Booking Details Panel -->
                    <div uib-collapse="!showBookingDetails" style="border-bottom: 1px solid #dee2e6;">
                        <div class="booking-details-container" style="padding: 15px; background-color: #f8f9fa;">
                            <div class="row">
                                <div class="col-md-12">
                                    <h4 style="margin-top: 0; color: #495057; font-size: 16px; margin-bottom: 15px; font-weight: 500;">
                                        <i class="fa fa-info-circle" style="color: #28a745; margin-right: 8px;"></i> Bidding Details
                                    </h4>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 col-sm-6">
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">Car:</span>
                                        <span style="color: #212529;">{{ bookingDetails.carName }}</span>
                                    </div>
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">Category:</span>
                                        <span style="color: #212529;">{{ bookingDetails.carCategory }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">From:</span>
                                        <span style="color: #212529;">{{ bookingDetails.startDate }}</span>
                                    </div>
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">To:</span>
                                        <span style="color: #212529;">{{ bookingDetails.endDate }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">Bid Price:</span>
                                        <span style="color: #212529; font-weight: 500;">${{ bookingDetails.bidAmount }}</span>
                                    </div>
                                    <div class="detail-item" style="margin-bottom: 10px;">
                                        <span style="font-weight: 500; color: #495057; display: inline-block; width: 90px;">Status:</span>
                                        <span class="label" ng-style="{'background-color': statusColor, 'color': 'white', 'padding': '3px 10px', 'border-radius': '10px', 'font-size': '11px', 'font-weight': '400'}">
                                            {{ bookingDetails.status }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="margin-top: 5px;">
                                <div class="col-md-12 text-right">
                                    <button class="btn btn-link btn-sm" ng-click="toggleDetails()" style="padding: 0; color: #6c757d;">
                                        <i class="fa fa-chevron-up"></i> Hide Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Area -->
                    <div class="messages-container" style="flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #f8f9fa;">
                        <div ng-if="messages.length === 0" class="text-center" style="padding: 40px 0; color: #6c757d;">
                            <i class="fa fa-comments-o fa-3x" style="margin-bottom: 15px; color: #dee2e6;"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                        
                        <div class="chat-messages">
                            <div ng-repeat="msg in messages" class="message-row" ng-class="{'message-row-sent': msg.sentBy !== 'owner', 'message-row-received': msg.sentBy === 'owner'}">
                                <div class="message-bubble" ng-class="{'message-sent': msg.sentBy !== 'owner', 'message-received': msg.sentBy === 'owner'}">
                                    <div ng-if="msg.isImage" class="message-image">
                                        <img ng-src="{{ msg.chatString }}" class="chat-image" style="max-width: 100%; border-radius: 8px; cursor: pointer;">
                                    </div>
                                    <div ng-if="!msg.isImage" class="message-text">
                                        {{ msg.chatString }}
                                    </div>
                                    <div class="message-time" ng-class="{'time-sent': msg.sentBy !== 'owner', 'time-received': msg.sentBy === 'owner'}">
                                        {{ msg.createdAt | date:'shortTime' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="input-container" style="padding: 15px; border-top: 1px solid #dee2e6; background-color: white;">
                        <div class="row">
                            <div class="col-md-9 col-sm-8 col-xs-8">
                                <textarea ng-model="messageInput" placeholder="Type a message..." class="form-control" style="resize: none; border-radius: 20px; height: 38px; padding-top: 8px;"></textarea>
                            </div>
                            <div class="col-md-1 col-sm-2 col-xs-2" style="padding-left: 0;">
                                <div class="image-upload-container">
                                    <input type="file" id="imageInput" accept="image/*" file-input="imageFile" style="display: none;">
                                    <label for="imageInput" class="btn btn-default" style="border-radius: 50%; width: 38px; height: 38px; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #ced4da;" title="Upload Image">
                                        <i class="fa fa-camera" style="color: #6c757d;"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-2 col-xs-2" style="padding-left: 0;">
                                <button ng-click="sendMessage(); messageInput = ''" class="btn btn-success" style="border-radius: 20px; width: 100%; background: linear-gradient(135deg, #28a745, #218838); border: none;">
                                    <i class="fa fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Message Bubble Styles */
    .chat-messages {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    
    .message-row {
        display: flex;
        margin-bottom: 15px;
        width: 100%;
    }
    
    .message-row-sent {
        justify-content: flex-end;
    }
    
    .message-row-received {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .message-sent {
        background: linear-gradient(135deg, #28a745, #218838);
        color: white;
        border-top-right-radius: 5px;
        margin-left: auto;
    }
    
    .message-received {
        background-color: white;
        color: #212529;
        border-top-left-radius: 5px;
        margin-right: auto;
    }
    
    .message-text {
        word-wrap: break-word;
    }
    
    .message-image {
        margin-bottom: 5px;
    }
    
    /* List Group Item Hover Effect */
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .list-group-item.active {
        background: linear-gradient(135deg, #28a745, #218838);
        border-color: #218838;
    }
    
    /* Button hover effect */
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .chat-sidebar {
            height: 40vh !important;
            width: 100%;
            border-right: none !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .chat-main {
            height: 60vh !important;
            width: 100%;
        }
        
        .col-md-3, .col-md-9 {
            width: 100%;
            padding: 0;
        }
        
        .row {
            margin: 0;
        }
        
        .message-bubble {
            max-width: 85%;
        }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 6px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Make textarea auto-resize */
    textarea {
        overflow: hidden;
    }
    
    /* Ensure height calculations work properly */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    
    .message-time {
        font-size: 11px;
        padding-top: 3px;
        opacity: 0.7;
        text-align: right;
    }
    
    .time-sent {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .time-received {
        color: rgba(33, 37, 41, 0.7);
    }
</style>

<script>
    // Scroll to bottom of messages container when new messages arrive
    function scrollToBottom() {
        var messagesContainer = document.querySelector('.messages-container');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    // Auto-resize textarea as user types
    document.addEventListener('input', function (e) {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            e.target.style.height = 'auto';
            e.target.style.height = (e.target.scrollHeight) + 'px';
        }
    }, false);
</script>

